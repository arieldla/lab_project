version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - node --version
      - npm --version

  pre_build:
    commands:
      - echo Preparing frontend build
      - SRC_DIR="${CODEBUILD_SRC_DIR}"
      - FRONTEND_APP_DIR="${FRONTEND_APP_DIR:-app}"
      - FRONTEND_BUILD_OUTPUT_DIR="${FRONTEND_BUILD_OUTPUT_DIR:-dist}"
      - FRONTEND_BUILD_COMMAND="${FRONTEND_BUILD_COMMAND:-npm ci && npm run build}"
      - echo SRC_DIR=${SRC_DIR}
      - echo FRONTEND_APP_DIR=${FRONTEND_APP_DIR}
      - echo FRONTEND_BUILD_OUTPUT_DIR=${FRONTEND_BUILD_OUTPUT_DIR}
      - cd "${SRC_DIR}/${FRONTEND_APP_DIR}"
      - pwd

  build:
    commands:
      - echo Running frontend build
      - bash -lc "${FRONTEND_BUILD_COMMAND}"

post_build:
  commands:
    - echo "Build complete. Syncing to S3..."
    - export BUILD_OUTPUT_PATH="$SRC_DIR/$FRONTEND_APP_DIR/$FRONTEND_BUILD_OUTPUT_DIR"
    - |
      if [ ! -d "$BUILD_OUTPUT_PATH" ]; then
        echo "Expected output dir not found: $BUILD_OUTPUT_PATH"
        echo "Trying common fallbacks..."
        if [ -d "$SRC_DIR/$FRONTEND_APP_DIR/dist" ]; then
          BUILD_OUTPUT_PATH="$SRC_DIR/$FRONTEND_APP_DIR/dist"
        elif [ -d "$SRC_DIR/$FRONTEND_APP_DIR/build" ]; then
          BUILD_OUTPUT_PATH="$SRC_DIR/$FRONTEND_APP_DIR/build"
        else
          echo "No dist/ or build/ directory found. Listing contents:"
          ls -la "$SRC_DIR/$FRONTEND_APP_DIR"
          exit 1
        fi
      fi
    - echo "Syncing from: $BUILD_OUTPUT_PATH"
    - aws s3 sync "$BUILD_OUTPUT_PATH" "s3://$SITE_BUCKET_NAME" --delete
    - |
      if [ -n "${CLOUDFRONT_DISTRIBUTION_ID}" ] && [ "${CLOUDFRONT_DISTRIBUTION_ID}" != "none" ]; then
        echo "Creating CloudFront invalidation..."
        aws cloudfront create-invalidation --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" --paths "/*"
      else
        echo "CloudFront disabled; skipping invalidation."
      fi

artifacts:
  files:
    - "**/*"
